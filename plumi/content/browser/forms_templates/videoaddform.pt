<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      i18n:domain="example.dexterityforms"
      metal:use-macro="context/main_template/macros/master">

    <metal:override fill-slot="column_two_slot">
    </metal:override>      
    <metal:block fill-slot="main">
        
        <h1 class="documentFirstHeading" tal:content="view/label | nothing" />
                
        <div id="content-core" tal:define="uploaded view/uploaded_file">
          
            <div class="row">
              <h4 id="loading-indicator">loading .. please wait</h4>
              <form id="videoaddmode-form" style="display: none;">
                <p><label for="videoaddmode">How do you want to add the video?</label></p>
                <input type="radio" name="videoaddmode" value="upload">upload a video<br />
                <input type="radio" name="videoaddmode" value="external">link to an external video on YouTube, Vimeo, etc.<br />
                <input type="submit" style="visibility: hidden;"/>
              </form>
            </div>
            
            <div id="uploader" style="display: none">
                <div id="multipleupload-code">
                    <script>var $_original = jQuery.noConflict();</script>
                    <script tal:attributes="src string:${context/@@plone_portal_state/portal_url}/++resource++collective.upload/jquery.1.7.1.js"></script>
                    <script>var j$ = $; $ = $_original; jQuery = $_original;</script>
                    <!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
                    <script tal:attributes="src string:${context/@@plone_portal_state/portal_url}/++resource++collective.upload/jquery.ui.widget.js"></script>
                    <!-- The Load Image plugin is included for the preview images and image resizing functionality -->
                    <script tal:attributes="src string:${context/@@plone_portal_state/portal_url}/++resource++collective.upload/load-image.min.js"></script>
                    <!-- The Canvas to Blob plugin is included for image resizing functionality -->
                    <script tal:attributes="src string:${context/@@plone_portal_state/portal_url}/++resource++collective.upload/canvas-to-blob.min.js"></script>
                    <script tal:attributes="src string:${context/@@plone_portal_state/portal_url}/++resource++collective.upload/jquery.iframe-transport.js"></script>
                    <script tal:attributes="src string:${context/@@plone_portal_state/portal_url}/++resource++collective.upload/jquery.fileupload.js"></script>

                    <!-- The File Upload image processing plugin -->
                    <script tal:attributes="src string:${context/@@plone_portal_state/portal_url}/++resource++collective.upload/jquery.fileupload-ip.js"></script>
                    <script tal:attributes="src string:${context/@@plone_portal_state/portal_url}/++resource++collective.upload/jquery.fileupload-ui.js"></script>
                    <script tal:attributes="src string:${context/@@plone_portal_state/portal_url}/++resource++collective.upload/media-upload-init-behavior.js"></script>
                </div>
                <link rel="stylesheet" type="text/css" media="screen" href="++resource++plumi.content.stylesheets/publish.css" />
                <div id="upload-form-top">
                    <form id="fileupload" action="." tal:attributes="action string:${context/absolute_url}/@@plumi_uploader" method="POST"
                    enctype="multipart/form-data">
                        <div class="row">
                            <div class="cell position-0 width-full fileupload-buttonbar">
                                <div class="controls" tal:condition="not: uploaded">
                                    <span class="btn success fileinput-button progressbar">
                                        <span i18n:translate="">Add a Video - Click or Drag & Drop</span>
                                        <span i18n:translate="" tal:condition="uploaded"><tal:filename tal:replace="uploaded/filename" /> - <tal:filesize tal:replace="uploaded/filesize" /></span>
                                        <input type="file" name="video_file" size="50" />
                                        <div style="width:0%;"></div>
                                    </span>
                                    <button type="reset" class="btn cancel" style="display: none">
                                        <span class="" i18n:translate="">Cancel upload</span>
                                    </button>
                                    <button type="reset" class="btn danger delete" style="display: none">
                                        <span class="" i18n:translate="">Delete file</span>
                                    </button>
                                </div>
                                <div class="controls" tal:condition="uploaded">
                                    <span class="btn success fileinput-button progressbar">
                                        <span i18n:translate=""><tal:filename tal:replace="uploaded/filename" /> - <tal:filesize tal:replace="uploaded/filesize" /></span>
                                        <input type="file" name="video_file" size="50" />
                                        <div style="width:100%;"></div>
                                    </span>
                                    <button type="reset" class="btn cancel" style="display: none">
                                        <span class="" i18n:translate="">Cancel upload</span>
                                    </button>
                                    <button type="reset" class="btn danger delete">
                                        <span class="" i18n:translate="">Delete file</span>
                                    </button>
                                </div>                                
                            </div>
                        </div>
                    </form>
                </div>    
            </div>
            <div id="videoaddform" class="row" style="display: none">
                <p>
                  HAVE YOU CATEGORISED YOUR VIDEO? Choose the Categorise tab 
                  below to make it easier for people to find your video, 
                  before clicking Save Changes.
                </p>
              
                <metal:block use-macro="context/@@ploneform-macros/titlelessform" />
            </div>
            <script language="javascript">
                // perform JavaScript after the document is scriptable.

                var jqXHR = null;
                
                function applyAddMode(mode) {
                  if (mode === 'upload') {
                    j$('#uploader').show();
                    j$('#videoaddform').show();
                    j$('.addModeToggle').prop('checked', false);
                  }
                  if (mode === 'external') {
                    j$('#uploader').hide();
                    j$('#videoaddform').show();
                    j$('.addModeToggle').prop('checked', true);
                  }
                }
                
                j$("input[name='videoaddmode']").change(function() {
                  var mode = $(this).val();
                  applyAddMode(mode);
                });
                
                j$('#fileupload').fileupload({ 
                    maxNumberOfFiles: 1,
                    autoUpload: true,
                     
                    add: function (e, data) {
                        jqXHR = data.submit();
                        $('.fileinput-button div').addClass('active');
                    },
                    
                    progress: function (e, data) {
                        $('.fileinput-button div.active').attr('style','width:' + 99*(data.loaded/data.total) + '%');
                    },
                    
                    done: function (e, data) {
                        $('#form-buttons-apply').removeAttr('disabled');
                        $('#form-buttons-apply').removeClass('disabled');
                        $('#form-buttons-apply').val('Save Changes');
                        $('.fileinput-button div').removeClass('active');
             
                        $('.fileinput-button div').attr('style','width: 100%');
                        $('button.cancel').hide();
                        $('button.delete').show();
                        $.each(data.files, function (index, file) {
                            $('.fileinput-button span').text(file.name + ' - ' + file.size);
                        });
                    },
                    
                    send: function (e,data) {
                        $('#form-buttons-apply').attr('disabled','disabled');
                        $('#form-buttons-apply').val('Uploading file...');
                        $('#form-buttons-apply').addClass('disabled');

                        $('.fileinput-button span').text('Uploading ' + data.files[0].name);
                        $('button.cancel').show();
                        $('button.delete').hide();

                    },
                    
                });
 
                j$('button.cancel').click(function (e) {
                    jqXHR.abort();
                    $('.fileinput-button div').removeClass('active');
                    $('.fileinput-button div').attr('style','width: 0%');
                    $('.fileinput-button span').text('Add a Video - Click or Drag & Drop');
                    $('#form-buttons-apply').removeAttr('disabled');
                    $('#form-buttons-apply').removeClass('disabled');
                    $('#form-buttons-apply').val('Save Changes');
                    $('.fileinput-button div').removeClass('active');                    
                    $('button.cancel').hide();
                    $.ajax({
                        type: "POST",
                        url: "plumi_uploader"});
                });

                j$('button.delete').click(function (e) {
                    $('.fileinput-button div').removeClass('active');
                    j$('#fileupload').fileupload('enable');
                    $('.fileinput-button div').attr('style','width: 0%');
                    $('.fileinput-button span').removeClass('left');
                    $('.fileinput-button span').text('Add a Video - Click or Drag & Drop');
                    $('button.delete').hide();
                    $.ajax({
                        type: "POST",
                        url: "plumi_uploader"});
                });
                
                
                f_abort = XMLHttpRequest.prototype.abort;
                XMLHttpRequest.prototype.abort = function() {
                    $.proxy(f_abort, this)();
                    if ($.active === 1) {
                        $.event.trigger("ajaxStop");
                                  $.active = 0;
                    } else if ($.active > 1) {
                        $.active--;
                    }
                };
                
                // show the add mode selection form after the page has finished loading
                j$("#loading-indicator").hide();
                j$("#videoaddmode-form").show();
                j$('#formfield-form-widgets-IsExternal').hide();
                if (j$('.portalMessage.error').length) {
                  console.log('found errors - fixing the form');
                  j$("#videoaddmode-form").hide();
                  var mode = j$("input[name='videoaddmode']").val();
                  applyAddMode(mode);
                }
            </script>
        </div>
        
    </metal:block>
    
</html>
